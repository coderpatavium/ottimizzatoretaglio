<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Ottimizzatore Taglio Barre</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            display: flex;
            gap: 30px;
        }

        .input-section, .output-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .input-section {
            width: 35%;
        }

        .output-section {
            width: 65%;
        }

        .parametri {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .parametri div {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }

        .input-row input {
            width: 100px;
            padding: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        th {
            background: #2c3e50;
            color: white;
        }

        .barra-grafica {
            display: flex;
            height: 40px;
            margin: 15px 0;
            border: 2px solid #333;
            position: relative;
        }

        .segmento {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 2px solid white;
            background: #4CAF50;
            color: white;
            font-weight: bold;
            position: relative;
        }

        .sfrido {
            background: #ff4444 !important;
        }

        .badge {
            background: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <!-- Sezione Input -->
    <div class="input-section">
        <h1>Input Dati</h1>
        
        <!-- Parametri in colonna -->
        <div class="parametri">
            <div>
                <h3>MI Barra (mm)</h3>
                <input type="number" id="barLength" value="3100">
            </div>
            <div>
                <h3>Lama (mm)</h3>
                <input type="number" id="bladeThickness" value="3">
            </div>
            <div>
                <h3>Intestatura (mm)</h3>
                <input type="number" id="header" value="10">
            </div>
        </div>

        <h2>Tagli Richiesti:</h2>
        <div id="cutsContainer">
            <!-- 30 righe vuote generate da JavaScript -->
        </div>

        <button onclick="calculate()" style="margin-top:20px; padding:12px 25px; width:100%">Calcola Ottimizzazione</button>
    </div>

    <!-- Sezione Output -->
    <div class="output-section">
        <h1>Risultati</h1>
        
        <div id="results">
            <h2>SVILUPPO:</h2>
            <table id="sviluppoTable">
                <tr>
                    <th>N° barre</th>
                    <th>MI usati</th>
                    <th>Sfrido</th>
                    <th>Tagli</th>
                </tr>
            </table>

            <h2>IN GRAFICA:</h2>
            <div id="graficaContainer"></div>
        </div>
    </div>

    <script>
        // Genera 30 righe vuote all'avvio
        window.onload = function() {
            const container = document.getElementById('cutsContainer');
            for(let i = 0; i < 30; i++) {
                const row = document.createElement('div');
                row.className = 'input-row';
                row.innerHTML = `
                    <input type="number" placeholder="Q.tà">
                    <input type="number" placeholder="mm">
                `;
                container.appendChild(row);
            }
        };

        function calculate() {
            // Reset risultati
            document.getElementById('sviluppoTable').innerHTML = `
                <tr>
                    <th>N° barre</th>
                    <th>MI usati</th>
                    <th>Sfrido</th>
                    <th>Tagli</th>
                </tr>`;
            document.getElementById('graficaContainer').innerHTML = '';

            // Parametri
            const barLength = parseInt(document.getElementById('barLength').value);
            const bladeThickness = parseInt(document.getElementById('bladeThickness').value);
            const header = parseInt(document.getElementById('header').value);
            const usableLength = barLength - header;

            // Leggi tagli
            const cuts = [];
            document.querySelectorAll('.input-row').forEach(row => {
                const qty = parseInt(row.querySelector('input[type="number"]:first-child').value) || 0;
                const len = parseInt(row.querySelector('input[type="number"]:last-child').value) || 0;
                for(let i = 0; i < qty; i++) {
                    cuts.push(len);
                }
            });

            // Algoritmo di ottimizzazione migliorato
            cuts.sort((a, b) => b - a);
            const bars = [];
            
            while(cuts.length > 0) {
                let bestCombination = null;
                let bestWaste = usableLength;

                // Trova la combinazione migliore
                for(let i = 1; i <= cuts.length; i++) {
                    const combination = cuts.slice(0, i);
                    const totalLength = combination.reduce((a, b) => a + b, 0) + ((combination.length - 1) * bladeThickness);
                    const waste = usableLength - totalLength;

                    if(waste >= 0 && waste < bestWaste) {
                        bestCombination = combination;
                        bestWaste = waste;
                    }
                }

                if(bestCombination) {
                    bars.push({
                        cuts: bestCombination,
                        totalSpace: bestCombination.reduce((a, b) => a + b, 0) + ((bestCombination.length - 1) * bladeThickness),
                        waste: bestWaste,
                        count: 1
                    });

                    // Rimuovi i tagli usati
                    bestCombination.forEach(cut => {
                        const index = cuts.indexOf(cut);
                        if(index !== -1) cuts.splice(index, 1);
                    });
                } else {
                    // Se non trova combinazioni valide, usa il taglio più grande
                    bars.push({
                        cuts: [cuts[0]],
                        totalSpace: cuts[0],
                        waste: usableLength - cuts[0],
                        count: 1
                    });
                    cuts.shift();
                }
            }

            // Raggruppa barre identiche
            const groupedBars = [];
            bars.forEach(bar => {
                const key = bar.cuts.join(',') + '|' + bar.waste;
                const existing = groupedBars.find(b => b.key === key);
                if(existing) {
                    existing.count++;
                } else {
                    groupedBars.push({
                        ...bar,
                        key: key,
                        count: 1
                    });
                }
            });

            // Genera output
            groupedBars.forEach((bar, index) => {
                // Tabella SVILUPPO
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bar.count}</td>
                    <td>${bar.totalSpace + header}</td>
                    <td>${bar.waste}mm (${((bar.waste / usableLength)*100).toFixed(1)}%)</td>
                    <td>${bar.cuts.join(' – ')}</td>
                `;
                document.getElementById('sviluppoTable').appendChild(row);

                // Grafica
                const barraDiv = document.createElement('div');
                barraDiv.className = 'barra-grafica';
                barraDiv.style.marginBottom = '30px';

                // Aggiungi tagli
                bar.cuts.forEach((taglio, i) => {
                    const width = (taglio / usableLength) * 100;
                    const segmento = document.createElement('div');
                    segmento.className = 'segmento';
                    segmento.style.width = `${width}%`;
                    segmento.innerHTML = `
                        <div>${taglio}mm</div>
                        ${i < bar.cuts.length - 1 ? 
                            `<div class="lama" style="position:absolute; right:-2px; background:#333; width:2px; height:100%"></div>` : ''}
                    `;
                    barraDiv.appendChild(segmento);
                });

                // Aggiungi sfrido
                if(bar.waste > 0) {
                    const wasteWidth = (bar.waste / usableLength) * 100;
                    const wasteDiv = document.createElement('div');
                    wasteDiv.className = 'segmento sfrido';
                    wasteDiv.style.width = `${wasteWidth}%`;
                    wasteDiv.innerHTML = `
                        <div>${bar.waste}mm</div>
                        <div style="font-size:0.8em">(${((bar.waste / usableLength)*100).toFixed(1)}%)</div>
                    `;
                    barraDiv.appendChild(wasteDiv);
                }

                // Etichetta quantità
                const label = document.createElement('div');
                label.style.position = 'absolute';
                label.style.left = '0';
                label.style.top = '-25px';
                label.innerHTML = `<span class="badge">N° ${bar.count}</span>`;
                barraDiv.appendChild(label);

                document.getElementById('graficaContainer').appendChild(barraDiv);
            });
        }
    </script>
</body>
</html>
